Ext.define("Ext.ux.WebSocket",{alias:"websocket",mixins:{observable:"Ext.util.Observable"},requires:["Ext.util.TaskManager","Ext.util.Memento"],config:{url:"",protocol:null,communicationType:"both",autoReconnect:true,autoReconnectInterval:5000,lazyConnection:false,keepUnsentMessages:false},CONNECTING:0,OPEN:1,CLOSING:2,CLOSED:3,memento:{},messageQueue:[],constructor:function(e){var f=this;if(Ext.isEmpty(e)){Ext.Error.raise("URL for the websocket is required!");return null}if(typeof e==="string"){e={url:e}}f.initConfig(e);f.mixins.observable.constructor.call(f,e);try{if(!f.getLazyConnection()){f.initWebsocket()}f.memento=Ext.create("Ext.util.Memento");f.memento.capture("autoReconnect",f)}catch(d){Ext.Error.raise(d);return null}return f},isReady:function(){return this.getStatus()===this.OPEN},getStatus:function(){return this.ws.readyState},close:function(){var b=this;if(b.autoReconnectTask){Ext.TaskManager.stop(b.autoReconnectTask);delete b.autoReconnectTask}b.setAutoReconnect(false);b.ws.close();return b},open:function(){var b=this;b.memento.restore("autoReconnect",false,b);b.initWebsocket();return b},send:function(){},initWebsocket:function(){var b=this;b.ws=Ext.isEmpty(b.getProtocol())?new WebSocket(b.getUrl()):new WebSocket(b.getUrl(),b.getProtocol());b.ws.onopen=function(a){if(b.autoReconnectTask){Ext.TaskManager.stop(b.autoReconnectTask);delete b.autoReconnectTask}if(b.getKeepUnsentMessages()&&b.messageQueue.length>0){while(b.messageQueue.length>0){if(b.isReady()){b.safeSend(b.messageQueue.shift())}else{break}}}b.fireEvent("open",b)};b.ws.onerror=function(a){b.fireEvent("error",b,a)};b.ws.onclose=function(a){b.fireEvent("close",b);if(b.getAutoReconnect()&&(typeof b.autoReconnectTask==="undefined")){b.autoReconnectTask=Ext.TaskManager.start({run:function(){if(b.getStatus()===b.CLOSED){b.initWebsocket()}},interval:b.getAutoReconnectInterval()})}};if(b.getCommunicationType()==="both"){b.ws.onmessage=Ext.bind(b.receiveBothMessage,this);b.send=Ext.bind(b.sendBothMessage,this)}else{if(b.getCommunicationType()==="event"){b.ws.onmessage=Ext.bind(b.receiveEventMessage,this);b.send=Ext.bind(b.sendEventMessage,this)}else{b.ws.onmessage=Ext.bind(b.receiveTextMessage,this);b.send=Ext.bind(b.sendTextMessage,this)}}},safeSend:function(c){var d=this;if(d.isReady()){d.ws.send(c)}else{if(d.getKeepUnsentMessages()){d.messageQueue.push(c)}}return d},receiveBothMessage:function(h){var e=this;try{var g=Ext.JSON.decode(h.data);e.fireEvent(g.event,e,g.data);e.fireEvent("message",e,g)}catch(f){if(Ext.isString(h.data)){e.fireEvent(h.data,e,h.data)}e.fireEvent("message",e,h.data)}},receiveEventMessage:function(h){var e=this;try{var g=Ext.JSON.decode(h.data);e.fireEvent(g.event,e,g.data);e.fireEvent("message",e,g)}catch(f){Ext.Error.raise(f)}},receiveTextMessage:function(f){var d=this;try{d.fireEvent(f,d,f);d.fireEvent("message",d,f)}catch(e){Ext.Error.raise(e)}},sendBothMessage:function(f,i){var j=this;if(arguments.length===1){if(Ext.isString(f)){j.safeSend(f)}else{Ext.Error.raise("String expected!")}}else{if(arguments.length>=2){f=Ext.isString(f)?[f]:f;for(var g=0;g<f.length;g++){var h={event:f[g],data:i};j.safeSend(Ext.JSON.encode(h))}}}return j},sendEventMessage:function(f,i){var j=this;f=Ext.isString(f)?[f]:f;for(var g=0;g<f.length;g++){var h={event:f[g],data:i};j.safeSend(Ext.JSON.encode(h))}return j},sendTextMessage:function(c){var d=this;d.safeSend(c);return d}});Ext.define("Ext.ux.WebSocketManager",{singleton:true,wsList:Ext.create("Ext.util.HashMap"),register:function(d){var c=this;if(Ext.isObject(d)){d=[d]}Ext.each(d,function(a){if(!Ext.isEmpty(a.url)){c.wsList.add(a.url,a)}})},contains:function(b){return this.wsList.containsKey(b.url)},get:function(b){return this.wsList.get(b)},each:function(b){this.wsList.each(function(f,e,a){b(e)})},unregister:function(d){var c=this;if(Ext.isObject(d)){d=[d]}Ext.each(d,function(a){if(c.wsList.containsKey(a.url)){c.wsList.removeAtKey(a.url)}})},broadcast:function(c,d){this.multicast([],c,d)},multicast:function(e,d,f){this.getExcept(e).each(function(b,a,c){if(a.isReady()){if(Ext.isEmpty(f)){a.send(d)}else{a.send(d,f)}}})},listen:function(d,c){if(Ext.isString(d)){d=[d]}this.wsList.each(function(b,a,f){Ext.each(d,function(e){a.on(e,c)})})},listenExcept:function(e,f,d){if(Ext.isString(e)){e=[e]}this.getExcept(f).each(function(b,a,c){Ext.each(e,function(h){a.on(h,d)})})},getExcept:function(d){if(Ext.isObject(d)){d=[d]}var c=this.wsList.clone();Ext.each(d,function(a){c.removeAtKey(a.url)});return c},closeAll:function(){var b=this;b.wsList.each(function(f,e,a){e.close();b.unregister(e)})}});